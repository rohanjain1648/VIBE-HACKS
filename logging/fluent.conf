# Fluentd configuration for Rural Connect AI log aggregation

<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

# Parse application logs
<filter rural-connect.**>
  @type parser
  key_name log
  reserve_data true
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%LZ
  </parse>
</filter>

# Add environment and service tags
<filter rural-connect.**>
  @type record_transformer
  <record>
    environment "#{ENV['ENVIRONMENT'] || 'production'}"
    service_name "#{ENV['SERVICE_NAME'] || 'rural-connect'}"
    hostname "#{Socket.gethostname}"
  </record>
</filter>

# Route error logs to separate output
<match rural-connect.error>
  @type copy
  <store>
    @type file
    path /fluentd/log/error
    append true
    time_slice_format %Y%m%d
    time_slice_wait 10m
    time_format %Y-%m-%dT%H:%M:%S.%LZ
    format json
  </store>
  <store>
    @type elasticsearch
    host elasticsearch
    port 9200
    index_name rural-connect-errors
    type_name error_log
    logstash_format true
    logstash_prefix rural-connect-errors
    flush_interval 10s
  </store>
</match>

# Route access logs
<match rural-connect.access>
  @type elasticsearch
  host elasticsearch
  port 9200
  index_name rural-connect-access
  type_name access_log
  logstash_format true
  logstash_prefix rural-connect-access
  flush_interval 10s
</match>

# Route application logs
<match rural-connect.app>
  @type copy
  <store>
    @type file
    path /fluentd/log/app
    append true
    time_slice_format %Y%m%d
    time_slice_wait 10m
    time_format %Y-%m-%dT%H:%M:%S.%LZ
    format json
  </store>
  <store>
    @type elasticsearch
    host elasticsearch
    port 9200
    index_name rural-connect-app
    type_name app_log
    logstash_format true
    logstash_prefix rural-connect-app
    flush_interval 10s
  </store>
</match>

# Catch all other logs
<match **>
  @type file
  path /fluentd/log/other
  append true
  time_slice_format %Y%m%d
  time_slice_wait 10m
  time_format %Y-%m-%dT%H:%M:%S.%LZ
  format json
</match>